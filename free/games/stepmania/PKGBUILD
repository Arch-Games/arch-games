# Contributor: August Gustavsson <august.g@telia.com>
# Contributor: Travis Nickles <ryoohki7@yahoo.com>
# Contributor: Joonas Niilola <juippis@roskakori.org>

pkgname=stepmania
pkgver=3.9
pkgrel=14
pkgdesc="An Advanced Dance Simulation Game"
url="http://www.stepmania.com/"
arch=('i686' 'x86_64')
license=('MIT')
depends=('ffmpeg' 'gtk2' 'libmad' 'lua' 'mesa')
makedepends=('pkgconfig' 'make' 'patch' 'autoconf' 'automake')
install=stepmania.install
source=(http://downloads.sourceforge.net/$pkgname/StepMania-$pkgver-linux.tar.gz 
	    http://downloads.sourceforge.net/$pkgname/StepMania-$pkgver-src.tar.gz 
		stepmania.patch 
		stepmania.desktop 
		stepmania.sh 
		stepmania.xpm)

md5sums=('c786dd30170e2770b6b1638f1115472b'
         '28bbbc985788bc990fa7042e2d7320b8'
         '477c3cfe5a9fdbe36ff468b9f3dc8f5d'
         '8fb95933764b52ab1fe6a099c779035e'
         '1cc95d5c33c9fac516ff1912be7e63c9'
         '10732965e8abf53ba4b85c63377daf2e')

build() {

	#Patch, build and install the package
	cd $srcdir/StepMania-$pkgver-src
	patch -Np1 -i $srcdir/stepmania.patch  || return 1
	aclocal -I autoconf/m4
	autoconf
	automake
	./configure --enable-force-oss
	make || return 1
	make bindir=/opt/$pkgname DESTDIR=$pkgdir install

	#Install the package data
	cd ../
	install -d StepMania-$pkgver/Cache/{Banners,Songs} StepMania-$pkgver/Data/LocalProfiles StepMania-$pkgver/Data/MachineProfile/{Edits,Screenshots}
	touch StepMania-$pkgver/{info,log}.txt
	rm -f StepMania-$pkgver/Data/MachineProfile/Stats.xml StepMania-$pkgver/{GtkModule.so,$pkgname}
	install -d -m755 $pkgdir/opt
 	cp -r StepMania-$pkgver $pkgdir/opt

	#Change file permissions so that users in the games group can write save data, write to log files, and add more content
	cd $pkgdir/opt/$pkgname
	chown -R root:games *
	chmod 2775 {Announcers,BGAnimations,Cache,CDTitles,Characters,Courses,Data,Docs,NoteSkins,RandomMovies,Songs,Themes,Visualizations}
	chmod 2775 Cache/{Banners,Songs}
	chmod 664 {info,log}.txt
	cd Data
	chmod 664 {AI.ini,Translation.dat,Unlocks.dat,splash.png}
	chmod 2775 LocalProfiles MachineProfile MachineProfile/{Edits,Screenshots}

	#Install the .desktop and icon files
	install -D -m644 $srcdir/$pkgname.desktop $pkgdir/usr/share/applications/$pkgname.desktop
	install -D -m644 $srcdir/$pkgname.xpm $pkgdir/usr/share/pixmaps/$pkgname.xpm
  
	#Install the license
	install -D -m644 $srcdir/$pkgname/Copying.txt $pkgdir/usr/share/licenses/$pkgname/Copying.txt

	#Install the bin file
	install -D -m755 $srcdir/$pkgname.sh $pkgdir/usr/bin/$pkgname
  
}
