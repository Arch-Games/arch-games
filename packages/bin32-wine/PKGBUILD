# Maintainer:  Devin Cofer <ranguvar@archlinux.us>
# Contributor: Clement Siuchung Cheung <clement.cheung@umich.edu>
# Contributor: Mikko Seppälä <t-r-a-y@mbnet.fi>

pkgname=bin32-wine
_pkgname32=wine
pkgver=1.1.29
pkgrel=1
_pkgrel32=1
pkgdesc="Win32 and Windows 3.x API interpreter, enabling one to run Windows apps on Linux"
arch=('x86_64')
url="http://www.winehq.org/"
license=('LGPL')

depends=('lib32-libxml2' 'lib32-fontconfig' 'lib32-libldap' 'lib32-libxslt' 'lib32-lcms' 'lib32-libxcursor'
         'lib32-libxrandr' 'lib32-libxdamage' 'lib32-mesa' 'lib32-util-linux-ng')
#olddepends=(lib32-libjpeg' 'lib32-libpng' 'lib32-alsa-lib' 'lib32-libxxf86vm' 'lib32-mesa' 'util-linux-ng' 'lib32-freetype2' 'lib32-fontconfig' 'lib32-libxslt' 'lib32-libxml2' 'lib32-libxcb' 'lib32-libxrender' 'lib32-libxdamage')
optdepends=('lib32-alsa-lib: ALSA driver'
            'lib32-nvidia-utils: Accelerated 3D with the NVIDIA binary blob video driver'
            'lib32-catalyst-utils: Accelerated 3D with the AMD/ATI binary blob video driver (Catalyst, aka fglrx)')
provides=("wine=$pkgver")
conflicts=('wine' 'wine-stable')

source=("http://rang.twilightlair.net/pkgs/$_pkgname32-$pkgver-$_pkgrel32-i686.pkg.tar.gz")
md5sums=('e32bf0bfc91e7efdd10e6da2c4ad5c86')


install="$pkgname".install
options=('!strip')

binarynames=(widl wine wine-kthread winebuild winecpp winedump wineg++ winegcc wineserver wmc wrc)

build() {
	rm "$_pkgname32-$pkgver-$_pkgrel32-i686.pkg.tar.gz" || return 1  # Delete symbolic link to the now-extracted source that we don't want to copy
	cp -rfpP * "$pkgdir" || return 1  # Copy 32-bit files
	install -d "$pkgdir/opt/lib32/usr/lib/"
	mv "$pkgdir/usr/lib/libwine.so"* "$pkgdir/opt/lib32/usr/lib/" || return 1
	cd "$pkgdir/usr/bin/"

	# DIRTY PKGBUILD TOUCHING YOUR /bin (force loading old LD_LIBRARY_PATH without moving wine binaries as they seem to break.
	install -d "$pkgdir/opt/wine/bin/" "$srcdir/tempscripts/"
	for i in ${binarynames[*]}; do
		#mv "$i" "$pkgdir/opt/wine/bin/"
		echo -e \
			'#!/bin/sh\n#wrapper for replacename\nPATH="/opt/wine/bin/:$PATH"\nLD_LIBRARY_PATH="/opt/lib32/usr/lib/:/opt/lib32/lib/:$LD_LIBRARY_PATH" linux32 /usr/bin/replacename "$@"' \
			> "$srcdir/tempscripts/$i" || return 1
		sed -re "s/replacename/$i/" -i "$srcdir/tempscripts/$i" || return 1
		install -m755 "$srcdir/tempscripts/$i" "$pkgdir/opt/wine/bin/$i" || return 1
	done
	rm -rf "$srcdir/tempscripts"

	# PPD fix
	mkdir -p "$pkgdir/opt/lib32/usr/share/"
	ln -s /usr/share/wine "$pkgdir//opt/lib32/usr/share/wine" || return 1

	echo "export WINELOADER=/opt/wine/bin/wine" > "$srcdir/wine.sh" || return 1
	echo '#export LD_LIBRARY_PATH="/opt/lib32/lib/:/opt/lib32/usr/lib/:$LD_LIBRARY_PATH"' >> "$srcdir/wine.sh" || return 1
	echo 'export PATH="/opt/wine/bin:$PATH"' >> "$srcdir/wine.sh" || return 1
	install -Dm755 "$srcdir/wine.sh" "$pkgdir/etc/profile.d/wine.sh" || return 1
}
