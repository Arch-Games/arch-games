# Contributor: Andrea Scarpino <bash.lnx@gmail.com>
# Contributor: Darwin Bautista <djclue917@gmail.com>

pkgname=planeshift
_pkgname=PlaneShift
pkgver=0.4.01
pkgrel=2
pkgdesc="Open source and cross-platform 3D Fantasy MMORPG"
arch=('i686' 'x86_64')
[ "${CARCH}" = "x86_64" ] && _arch="x64" || _arch="x86"
[ "${CARCH}" = "x86_64" ] && __arch="64" || __arch="32"
url="http://www.planeshift.it/"
license=('GPL' 'custom:PlaneShift Content License')
depends=('libgl' 'libsm' 'libxmu' 'libxpm' 'openal' 'openssl' 'zlib' 'unzip')
options=('emptydirs')
install=planeshift.install
source=(http://download.xordan.com/${_pkgname}-v${pkgver}-${_arch}.bin 
		http://www.psmirror.org/psupdaterlinux${__arch}.zip
        planeshift.desktop 
        planeshiftsetup.desktop 
        planeshiftupdater.desktop 
        license.txt 
        updaterinfo.xml
		scriptfix.patch)
		
md5sums=('63e902a60255a666076799938cddcad4' 
		 '83ffd1795101979ae27b124624f4b8cf' 
		 '5be27f6e51c8edff591aa1fdc668b7e9' 
		 'e75381f677b5d2ae331d0e4e742ee21a' 
		 '4e8d4876b9c99db92d6dcb3e0c22128e' 
		 'dbac9cf5bfb63463bcb2b5ea09b00586' 
		 '9d8a6db70eb721c261b5bf6de009a958'
		 '7fd2fbcf084ecbdded13781473e6e8ed')

[ "${CARCH}" = "x86_64" ] && md5sums[0]='4af929f7a164386b4089922327f72b6e' 
[ "${CARCH}" = "x86_64" ] && md5sums[1]='0fd8757dc309df6b36b713f142d35212'

build() {
  cd ${srcdir}
  # Make the installer executable
  chmod +x ${_pkgname}-v${pkgver}-${_arch}.bin
  # Extract the files
  ./${_pkgname}-v${pkgver}-${_arch}.bin \
    --mode unattended \
    --syswide yes \
    --prefix ${pkgdir}/opt
  # Replace files with the patched ones
  mv psupdater ${pkgdir}/opt/${_pkgname}/
  mv psupdater.bin ${pkgdir}/opt/${_pkgname}/
  mv updaterinfo.xml ${pkgdir}/opt/${_pkgname}/
  # Change group to games
  chown -R root:games ${pkgdir}/opt/${_pkgname}
  # Set correct permissions for files and folders
  find ${pkgdir}/opt/${_pkgname} -type f -exec chmod 660 {} +
  find ${pkgdir}/opt/${_pkgname} -type d -exec chmod 770 {} +
  cd ${pkgdir}/opt/${_pkgname}
  # Set correct permissions for executables
  chmod 770 psclient.bin pssetup.bin psupdater.bin
  # Install scripts to proper directory
  install -D -m755 psclient ${pkgdir}/usr/bin/$pkgname
  install -D -m755 pssetup ${pkgdir}/usr/bin/$pkgname-setup
  install -D -m755 psupdater ${pkgdir}/usr/bin/$pkgname-updater
  # Remove unnecessary files
  rm uninstall unscript.sh $pkgname $pkgname-setup $pkgname-updater psclient pssetup psupdater
  cd ${srcdir}
  #fix script
  patch -Np0 < scriptfix.patch || return 1
  # Install shortcuts
  mkdir -p $startdir/pkg/usr/share/applications
  install -m644 $startdir/src/*.desktop $startdir/pkg/usr/share/applications/
  # Install the PlaneShift Content License
  install -D -m644 $startdir/src/license.txt $startdir/pkg/usr/share/licenses/$pkgname/license.txt
}
