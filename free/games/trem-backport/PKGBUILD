# Contributor: Stythys <twilight.lair@gmail.com>
pkgname=trem-backport
pkgver=931_4
_realpkgver=931-4
_trempkgname="tremulous"
_trempkgver=1.1.0
pkgrel=2
pkgdesc="The tremulous Merceneries's Guild backport client"
arch=('i686')
url="http://tremulous.net/"
license=('GPL')
depends=('sdl' 'openal')
conflicts=('tremulous')
provides=('tremulous=1.1.0')
source=(http://downloads.sourceforge.net/sourceforge/tremulous/$_trempkgname-$_trempkgver.zip data-svn931-backport-4.pk3 vms-svn931-backport-4.pk3 
http://releases.mercenariesguild.net/client/linux_x86_x64/tremulous.x86_64 http://releases.mercenariesguild.net/client/linux_x86/tremulous.x86
http://releases.mercenariesguild.net/client/mg-client-manual.txt)

build() {
  cd $srcdir
  mv tremulous/tremulous-$_trempkgver-src.tar.gz .
  tar zxvf tremulous-$_trempkgver-src.tar.gz
  cd $srcdir/tremulous
  rm {CC,COPYING,ChangeLog,GPL,tremulous.exe,tremded.x86,tremulous.x86}
  cd $srcdir
  install -d $pkgdir/opt/
  mv tremulous/ $pkgdir/opt/
  cd $srcdir/tremulous-$_trempkgver-src
  sed s/" -Werror"//g ./src/tools/asm/Makefile >> ./Makefile.tmp
  mv ./Makefile.tmp src/tools/asm/Makefile
  make || return 1
  if [ "$CARCH" = "x86_64" ]; then
        #
        # x86_64 Systems
        #
        # Install Binaries
        install -m755 build/release-linux-x86_64/*.x86_64 \
            $pkgdir/opt/tremulous
        # Modify Launcher Scripts to use x86_64 Binaries
        /bin/sed -i "s:TREM_BINARY:tremulous.x86_64:" \
            $srcdir/tremulous.launcher
        /bin/sed -i "s:TREM_BINARY:tremded.x86_64:" \
            $srcdir/tremded.launcher
    else
        #
        # i686 Systems
        #
        # Install Binaries
        install -m755 build/release-linux-x86/*.x86 \
            $pkgdir/opt/tremulous
        # Modify Launcher Scripts to use i686 Binaries
        /bin/sed -i "s:TREM_BINARY:tremulous.x86:" \
            $srcdir/tremulous.launcher
        /bin/sed -i "s:TREM_BINARY:tremded.x86:" \
            $srcdir/tremded.launcher
    fi
  cd $srcdir
  install -d $pkgdir/opt/tremulous
  install -d $pkgdir/opt/tremulous/base
  cp tremulous.x86 $pkgdir/opt/tremulous
  cp data-svn931-backport-4.pk3 $pkgdir/opt/tremulous/base/
  cp vms-svn931-backport-4.pk3 $pkgdir/opt/tremulous/base/

  install -Dm644 $srcdir/mg-client-manual.txt $pkgdir/usr/share/tremulous/mg-client-manual.txt
}
