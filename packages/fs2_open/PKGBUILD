# Contributor: Lone_Wolf <lonewolf@xs4all.nl>
pkgname=fs2_open
pkgver=3.6.9
pkgrel=2
pkgdesc="FS2_open is an enhancement of the original Freespace 2 engine"
arch=('i686')
url="http://scp.indiegames.us"
license=('custom')
depends=('freealut' 'libvorbis' 'sdl' 'libtheora')
makedepends=('cvs' 'unshield' 'automake' 'lua' 'unrar' 'tmv')

source=(  http://fs2source.warpcore.org/mvp368zeta/mv_zpack.zip http://fs2source.warpcore.org/mediavp/mp-710_effects.rar          http://fs2source.warpcore.org/mediavp/mp-710_models.rar fs2.tar.gz fs2_open fs2_open.desktop fs2_open.png readme.1st)
md5sums=(
  'ece7d08d209265d7f5ebc863d214f57a'  #mv_zpack.zip 
  '2b740cd02c88ac9fa3ee370453804a18'  #mp-710_effects.rar
  'cdf6ab6e2a068805a17a68776e48e223'  #mp-710_models.rar
  'b674b3d8b88adb5e8941c044bd941aa4'  #fs2.tar.gz
  'e82a7def515f75324d6a134f34e7505c'  #fs2_open
  '3e04bf37ab32301ea3de563cd6f295ce'  #fs2_open.desktop
  'f309e833b6fe70b078b921a9e4c16501'  #fs2_open.png
  '590d4feb61030ac2345ef928251e326d'  #readme.1st
)

# CVS Variables
_cvsroot=":pserver:anonymous:anonymous:@warpcore.org:/home/fs2source/cvsroot"
_cvsmod="fs2_open"
_cvsbranch=fs2_open_3_6_9

build()
{
# making directories
    mkdir -p $startdir/src/{build,temp/retailvp,temp/mediavps}
    mkdir -p $startdir/pkg/usr/bin
    mkdir -p $startdir/pkg/usr/share/$pkgname/{data/movies,data/players,mediavps}
    mkdir -p $startdir/pkg/usr/share/{licenses/$pkgname,applications,icons/hicolor/32x32/apps/}

# extracting files from retail version, MediaVP files and movies"
    msg "extracting/copying necessary files"
    cd $startdir/src

# extract retail vp files from data1.cab
    for group in "Basic Install Files" "Intel Anims" "Music Compressed" "High Res Files"
      do unshield -d temp/retailvp -g "$group" -L -j x data1.cab
    done
    install -D -m644 -t $startdir/pkg/usr/share/$pkgname temp/retailvp/*/*
    unshield -d temp -g "Hud Config Files" -L -j x data1.cab
    install -D -m644 -t $startdir/pkg/usr/share/$pkgname/data/players temp/hud_config_files/*

# other retail vp files
    install -D -m644 -t $startdir/pkg/usr/share/$pkgname tango1_fs2.vp tango2_fs2.vp tango3_fs2.vp

# movies
    install -D -m644 -t $startdir/pkg/usr/share/$pkgname/data/movies *.MVE

# SCP media files
    install -D -m644 -t $startdir/pkg/usr/share/$pkgname/mediavps mv*.vp 
    unrar x mp-710_effects.rar temp/mediavps
    unrar x mp-710_models.rar temp/mediavps
    install -D -m644 -t $startdir/pkg/usr/share/$pkgname/mediavps temp/mediavps/*

# setting all filenames to lowercase
    tmv-l $startdir/pkg/usr/share/$pkgname/ 

# download cvs code
    msg "Downloading from $_cvsmod CVS server...."
    cd $startdir/src
#   cvs -z9 -q -d $_cvsroot co -D $pkgver -f $_cvsmod
    cvs -z3 -q -d $_cvsroot co -d $_cvsbranch -r $_cvsbranch $_cvsmod
    msg "CVS checkout done or server timeout"

# making executable  
    msg "Starting build..."
    cp -r $_cvsbranch build
    cd build/$_cvsbranch
    ./autogen.sh CXXFLAGS="-march=i686 -O2 -pipe"
    make || return 1

# copy executable
    install -D -m755 $startdir/src/build/$_cvsbranch/code/fs2_open_r $startdir/pkg/usr/share/$pkgname/fs2_open_r

# copy license, icon & KDE/GNOME menu entry
    install -D -m644 $startdir/src/build/$_cvsbranch/COPYING $startdir/pkg/usr/share/licenses/$pkgname/copying
    install -D -m644 $startdir/src/fs2_open.desktop $startdir/pkg/usr/share/applications/fs2_open.desktop
    install -D -m644 $startdir/src/fs2_open.png $startdir/pkg/usr/share/icons/hicolor/32x32/apps/fs2_open.png

# copy a batch file that runs the scp/fs2_open mod
    install -D -m755 $startdir/src/fs2_open $startdir/pkg/usr/bin/fs2_open
}