# Contributor: Travis Nickles <ryoohki7@yahoo.com>
# Contributor: Stefan Lohmaier <noneuss at gmail dot com>

pkgname=stepmania-svn
pkgver=28129
pkgrel=1
pkgdesc="SVN version of StepMania. StepMania 4.0 Beta"
url="http://www.stepmania.com/wiki/StepMania_4.0"
license=('MIT')
arch=(i686 x86_64)
depends=('gtk2' 'libmad' 'libtheora' 'mesa' 'ffmpeg')
makedepends=('pkgconfig' 'subversion')
source=(loading.xpm $pkgname-gcc43.patch $pkgname-multiuser.patch $pkgname-autogen.patch \
$pkgname-window-icons.patch $pkgname.desktop $pkgname.sh $pkgname.xpm)
_svntrunk=https://svn.stepmania.com/svn/trunk/stepmania/
_svnmod=stepmania

build() {
    cd $startdir/src

    msg "Connecting to StepMania SVN server...."
    svn co $_svntrunk $_svnmod --config-dir ./ -r $pkgver

    msg "SVN checkout done or server timeout"
    msg "Starting make..."

    #cp -f loading.xpm $_svnmod/src/arch/LoadingWindow
    #cp -f $pkgname.xpm $_svnmod/src/arch/LoadingWindow/stepmania.xpm
    #cp -f $pkgname.xpm $_svnmod/src/archutils/Unix/stepmania.xpm

    cd $_svnmod
    msg "Patching..."
    patch -Np0 -i $startdir/src/$pkgname-gcc43.patch
    patch -Np0 -i $startdir/src/$pkgname-multiuser.patch
    patch -Np0 -i $startdir/src/$pkgname-autogen.patch
    #patch -Np1 -i $startdir/src/$pkgname-window-icons.patch
    msg "Running aclocal..."
    aclocal || return 1
    msg "Running autoconf..."
    autoconf || return 1
    msg "Running autogen..."
    sh autogen.sh || return 1
    #./configure
    #make
    msg "Building..."
    ./Utils/build.sh --verbose || return 1
    mkdir -p $startdir/pkg/opt/$pkgname || return 1
    #cp src/stepmania src/GtkModule.so $startdir/pkg/opt/$pkgname
    cp stepmania GtkModule.so $startdir/pkg/opt/$pkgname || return 1

    install -D -m755 $startdir/src/$pkgname.sh $startdir/pkg/usr/bin/$pkgname
    install -D -m644 $startdir/src/$pkgname.desktop $startdir/pkg/usr/share/applications/$pkgname.desktop
    install -D -m644 $startdir/src/$pkgname.xpm $startdir/pkg/usr/share/pixmaps/$pkgname.xpm
    install -D -m644 $startdir/src/$_svnmod-build/Docs/Licenses.txt $startdir/pkg/usr/share/licenses/$pkgname/Licenses.txt

    cp -r {Announcers,BackgroundEffects,BackgroundTransitions,BGAnimations,CDTitles,Characters,\
Courses,Data,Docs,NoteSkins,Packages,RandomMovies,Songs,Themes} $startdir/pkg/opt/$pkgname

    find $startdir/pkg/opt/$pkgname -type d -name ".svn" -exec rm -rf '{}' +;
    rm -f $startdir/pkg/opt/$pkgname/Docs/{*.gif,LUA*,Lua*,README-GUIDELINES,\
SMLanProtocol.txt,Stats.xml,TODO.*}
}
